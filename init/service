#/bin/sh
# external interface for `service-core`
COMMAND="$1"
USAGE="Usage: ./$0 COMMAND SERVICE
COMMAND
	restart
		stop, then start SERVICE
	start
		lift a persistent hold from SERVICE
	status
		print the status of SERVICE
	stop
		place a persistent hold on SERVICE
SERVICE
	the service name"

# grab utilities

. `realpath "service-core"` --source-only ######################can't pass args via . in POSIX

if [ ! $? ]
then
  echo "Failed to source \`service-core\`."
  exit 1
fi
_SERVICE="$2"
_SERVICE_DIR="$ENABLED_DIR/$SERVICE"

if [ ! -e "$_SERVICE_DIR" ]
then
  echo "Unrecognized service." >&2
  exit 1
elif [ ! -d "$_SERVICE_DIR" ]
then
  echo "Not a service directory." >&2
  exit 1
fi

case "$COMMAND"
in
  restart)
    hold_service "$_SERVICE"
    
    while is_running "$_SERVICE"
    do
      sleep "$SLEEP";
    done
    unhold_service "$_SERVICE"
    
    while ! is_running "$_SERVICE"
    do
      sleep "$SLEEP";
    done
    echo "Restarted service \"$_SERVICE\"."
    ;;
  "start")
    unset_hold "$_SERVICE"
    
    while ! is_running "$_SERVICE"
    do
      sleep "$SLEEP"
    done
    echo "Started service \"$_SERVICE\"."
    ;;
  "status")
      if is_running "$_SERVICE"
      then
        echo "Service \"$_SERVICE\" is running."
      elif [ -e "$SERVICE_DIR/hold" ]
      then
        echo "Service \"$_SERVICE\" is stopped."
      else
        echo "Service \"$_SERVICE\" crashed."
      fi
    ;;
  "stop")
    hold_service "$_SERVICE"
    
    while is_running "$_SERVICE"
    do
      sleep "$SLEEP"
    done
    echo "Stopped service \"$_SERVICE\"."
    ;;
  *)
    echo "Invalid command." >&2
    echo "$HELP"
    exit 1
esac

